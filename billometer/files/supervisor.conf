{%- set service = salt['pillar.get']('supervisor:server:service:'+service_name) %}
{%- from "billometer/map.jinja" import server with context %}

[program:{{ service_name }}]
directory={{ server.dir.base }}
environment=PATH="{{ server.dir.base }}/bin",PYTHONPATH='{{ server.dir.base }}/lib/python2.6/site-packages'
{%- if service.name == 'api' %}
command=/srv/billometer/bin/gunicorn_start
{%- endif %}
{%- if service.name == 'collector' %}
command={{ server.dir.base }}/bin/celery worker -s {{ server.dir.base }}/logs/celerybeat-schedule -B -E --hostname=collector@{{ grains.fqdn }} --loglevel=INFO --concurrency=1 --config=celery_config --workdir={{ server.dir.base }}/site --logfile={{ server.dir.base }}/logs/collector.log
{%- endif %}
{%- if service.name == 'monitor' %}
command=/srv/billometer/site/manage.py celerycam
{%- endif %}
stdout_logfile={{ server.dir.base }}/logs/{{ server.name }}_app.log 
stderr_logfile={{ server.dir.base }}/logs/{{ server.name }}_error.log
user=billometer
autostart=true
autorestart=true
