{%- set service = salt['pillar.get']('supervisor:server:service:'+service_name) %}
{%- from "billometer/map.jinja" import server with context %}

[program:{{ service_name }}]
directory={{ server.dir.base }}
{%- if service.name == 'api' %}
command={{ server.dir.base }}/bin/gunicorn_start.sh
{%- endif %}
{%- if service.name == 'collector' %}
command={{ server.dir.base }}/bin/celery worker -s {{ server.dir.base }}/logs/celerybeat-schedule -B -E --hostname=collector@{{ grains.fqdn }} --loglevel=INFO --concurrency=1 --config=billometer.settings --workdir={{ server.dir.base }} --logfile={{ server.dir.base }}/logs/collector.log
{%- endif %}
{%- if service.name == 'monitor' %}
command={{ server.dir.base }}/bin/manage.py celerycam
{%- endif %}
stdout_logfile={{ server.dir.base }}/logs/{{ service.name }}_app.log 
stderr_logfile={{ server.dir.base }}/logs/{{ service.name }}_error.log
user=billometer
autostart=true
autorestart=true
